<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WorkeråŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      margin: 10px 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    input[type="file"] {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>WorkeråŠŸèƒ½æµ‹è¯• - v2.0.1</h1>
  
  <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h3 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ”§ æ–°åŠŸèƒ½æµ‹è¯•</h3>
    <p style="margin: 0; color: #555; font-size: 14px;">
      æµ‹è¯• ParallelFileUploader v2.0.1 çš„æ–°åŠŸèƒ½ï¼ŒåŒ…æ‹¬è°ƒè¯•æ¨¡å¼ã€é€šé…ç¬¦æ”¯æŒã€å¢å¼ºé”™è¯¯å¤„ç†ç­‰ã€‚
    </p>
  </div>
  
  <div>
    <input type="file" id="fileInput" multiple accept="*/*">
    <br>
    <button onclick="testWorkerInitialization()">æµ‹è¯•Workeråˆå§‹åŒ–</button>
    <button onclick="testFileUpload()">æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </button>
    <button onclick="testUploaderFeatures()">ğŸ”§ æµ‹è¯•æ–°åŠŸèƒ½</button>
    <button onclick="testFileTypeValidation()">ğŸ”§ æµ‹è¯•æ–‡ä»¶ç±»å‹éªŒè¯</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>
  
  <h3>æ—¥å¿—è¾“å‡ºï¼š</h3>
  <div id="log" class="log"></div>

  <script type="module">
    // å¯¼å…¥æ¨¡å—ï¼ˆéœ€è¦é€‚é…å®é™…çš„æ„å»ºè¾“å‡ºï¼‰
    let ParallelFileUploader;
    
    // ç®€åŒ–ç‰ˆçš„ä¸Šä¼ å™¨ï¼Œåªæµ‹è¯•WorkeråŠŸèƒ½
    function log(message) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.textContent += `[${timestamp}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // æµ‹è¯•Workeråˆå§‹åŒ–
    window.testWorkerInitialization = function() {
      log('å¼€å§‹æµ‹è¯•Workeråˆå§‹åŒ–...');
      
      try {
        // ç®€å•æµ‹è¯•Workeræ˜¯å¦æ”¯æŒ
        if (typeof Worker === 'undefined') {
          log('âŒ æµè§ˆå™¨ä¸æ”¯æŒWeb Worker');
          return;
        }
        
        log('âœ… æµè§ˆå™¨æ”¯æŒWeb Worker');
        
        // æµ‹è¯•inline Workeråˆ›å»º
        const workerCode = `
          const ctx = self;
          ctx.onmessage = function(e) {
            if (e.data.type === 'test') {
              ctx.postMessage({ type: 'response', message: 'Workeræµ‹è¯•æˆåŠŸï¼' });
            }
          };
          ctx.postMessage({ type: 'ready' });
        `;
        
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);
        const worker = new Worker(workerUrl);
        
        worker.onmessage = function(e) {
          if (e.data.type === 'ready') {
            log('âœ… Workeråˆ›å»ºæˆåŠŸï¼Œå‘é€æµ‹è¯•æ¶ˆæ¯...');
            worker.postMessage({ type: 'test' });
          } else if (e.data.type === 'response') {
            log(`âœ… ${e.data.message}`);
            worker.terminate();
            URL.revokeObjectURL(workerUrl);
          }
        };
        
        worker.onerror = function(error) {
          log(`âŒ Workeré”™è¯¯: ${error.message || error.type}`);
          URL.revokeObjectURL(workerUrl);
        };
        
      } catch (error) {
        log(`âŒ Workeråˆå§‹åŒ–å¤±è´¥: ${error.message}`);
      }
    };

    // æµ‹è¯•æ–‡ä»¶ä¸Šä¼ ï¼ˆæ¨¡æ‹Ÿï¼‰
    window.testFileUpload = function() {
      const fileInput = document.getElementById('fileInput');
      const files = fileInput.files;
      
      if (files.length === 0) {
        log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }
      
      log(`å¼€å§‹æµ‹è¯•${files.length}ä¸ªæ–‡ä»¶çš„ä¸Šä¼ ...`);
      
      Array.from(files).forEach((file, index) => {
        log(`æ–‡ä»¶ ${index + 1}: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
        
        // æ¨¡æ‹Ÿæ–‡ä»¶åˆ†ç‰‡
        const chunkSize = 1024 * 1024; // 1MB
        const chunks = Math.ceil(file.size / chunkSize);
        log(`  - å°†åˆ†æˆ ${chunks} ä¸ªåˆ†ç‰‡`);
        
        // æ¨¡æ‹ŸWorkerå¤„ç†
        for (let i = 0; i < Math.min(chunks, 3); i++) {
          const start = i * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunkBlob = file.slice(start, end);
          
          log(`  - åˆ†ç‰‡ ${i + 1}: ${start} - ${end} (${(chunkBlob.size / 1024).toFixed(2)} KB)`);
        }
        
        if (chunks > 3) {
          log(`  - ... è¿˜æœ‰ ${chunks - 3} ä¸ªåˆ†ç‰‡`);
        }
      });
      
      log('âœ… æ–‡ä»¶åˆ†ç‰‡æµ‹è¯•å®Œæˆ');
    };

    // ğŸ”§ æµ‹è¯•ä¸Šä¼ å™¨æ–°åŠŸèƒ½
    window.testUploaderFeatures = async function() {
      log('=== å¼€å§‹æµ‹è¯• ParallelFileUploader v2.0.1 æ–°åŠŸèƒ½ ===');
      
      try {
        // åŠ¨æ€å¯¼å…¥ä¸Šä¼ å™¨
        const { ParallelFileUploader } = await import('../lib/index.js');
        log('âœ… æˆåŠŸå¯¼å…¥ ParallelFileUploader');
        
        // åˆ›å»ºå¸¦æœ‰æ–°åŠŸèƒ½çš„ä¸Šä¼ å™¨å®ä¾‹
        const uploader = new ParallelFileUploader({
          debugMode: true, // ğŸ”§ æ–°åŠŸèƒ½ï¼šè°ƒè¯•æ¨¡å¼
          allowedFileTypes: ['*'], // ğŸ”§ æ–°åŠŸèƒ½ï¼šé€šé…ç¬¦æ”¯æŒ
          maxFileSize: 5 * 1024 * 1024, // 5MB é™åˆ¶
          maxConcurrentFiles: 2,
          chunkSize: 1024 * 1024,
          
          // æ¨¡æ‹ŸæœåŠ¡å™¨å›è°ƒ
          sendFileInfoToServer: async (fileInfo) => {
            log(`ğŸ“¤ æ¨¡æ‹Ÿå‘é€æ–‡ä»¶ä¿¡æ¯: ${fileInfo.fileName}`);
            return { isSuccess: true, data: {} };
          },
          
          sendFilePartToServer: async (fileInfo, chunkInfo) => {
            log(`ğŸ“¦ æ¨¡æ‹Ÿä¸Šä¼ åˆ†ç‰‡: ${fileInfo.fileName} part ${chunkInfo.partNumber}`);
            return { isSuccess: true, data: { etag: 'mock-etag' } };
          },
          
          // ğŸ”§ æ–°åŠŸèƒ½ï¼šæ–‡ä»¶è¢«æ‹’ç»å›è°ƒ
          onFileRejected: (file, reason) => {
            log(`âŒ æ–‡ä»¶è¢«æ‹’ç»: ${file.name} - ${reason}`);
          },
          
          onFileAdded: (fileInfo) => {
            log(`âœ… æ–‡ä»¶å·²æ·»åŠ : ${fileInfo.fileName} (${(fileInfo.fileSize / 1024).toFixed(2)} KB)`);
          }
        });
        
        log('âœ… æˆåŠŸåˆ›å»ºä¸Šä¼ å™¨å®ä¾‹');
        
        // ğŸ”§ æµ‹è¯•æ–°APIæ–¹æ³•
        log('\n--- æµ‹è¯•æ–°APIæ–¹æ³• ---');
        
        // è·å–é…ç½®ä¿¡æ¯
        const config = uploader.getConfiguration();
        log('ğŸ“Š é…ç½®ä¿¡æ¯:');
        log(`  - åˆ†ç‰‡å¤§å°: ${config.chunkManager.chunkSize}`);
        log(`  - æ–‡ä»¶ç±»å‹: ${config.fileManager.supportedTypesDescription}`);
        log(`  - Workeræ”¯æŒ: ${config.features.workerSupport}`);
        log(`  - è°ƒè¯•æ¨¡å¼: å¯ç”¨`);
        
        // æµ‹è¯•è°ƒè¯•æ¨¡å¼åˆ‡æ¢
        log('\nğŸ” æµ‹è¯•è°ƒè¯•æ¨¡å¼åˆ‡æ¢:');
        uploader.setDebugMode(false);
        log('  - è°ƒè¯•æ¨¡å¼å·²ç¦ç”¨');
        uploader.setDebugMode(true);
        log('  - è°ƒè¯•æ¨¡å¼å·²é‡æ–°å¯ç”¨');
        
        // è·å–ç»Ÿè®¡ä¿¡æ¯
        const stats = uploader.getStats();
        log(`\nğŸ“ˆ é˜Ÿåˆ—ç»Ÿè®¡: é˜Ÿåˆ—${stats.queued}ä¸ª, æ´»åŠ¨${stats.active}ä¸ª`);
        
        // è·å–æ€§èƒ½æ•°æ®
        const perfData = uploader.getPerformanceData();
        log(`ğŸ“Š æ€§èƒ½æ•°æ®: å½“å‰é€Ÿåº¦${perfData.currentSpeed}bytes/s, å¹³å‡é€Ÿåº¦${perfData.averageSpeed}bytes/s`);
        
        // å°†ä¸Šä¼ å™¨å®ä¾‹ä¿å­˜åˆ°å…¨å±€ï¼Œä¾›å…¶ä»–æµ‹è¯•ä½¿ç”¨
        window.testUploader = uploader;
        log('âœ… ä¸Šä¼ å™¨å®ä¾‹å·²ä¿å­˜åˆ° window.testUploader');
        
      } catch (error) {
        log(`âŒ æ–°åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    };

    // ğŸ”§ æµ‹è¯•æ–‡ä»¶ç±»å‹éªŒè¯
    window.testFileTypeValidation = function() {
      log('=== å¼€å§‹æµ‹è¯•æ–‡ä»¶ç±»å‹éªŒè¯åŠŸèƒ½ ===');
      
      if (!window.testUploader) {
        log('âŒ è¯·å…ˆè¿è¡Œ"æµ‹è¯•æ–°åŠŸèƒ½"æ¥åˆ›å»ºä¸Šä¼ å™¨å®ä¾‹');
        return;
      }
      
      // åˆ›å»ºä¸åŒç±»å‹çš„æµ‹è¯•æ–‡ä»¶
      const testFiles = [
        // æ™®é€šæ–‡æœ¬æ–‡ä»¶
        new File(['Hello World'], 'test.txt', { type: 'text/plain' }),
        // å›¾ç‰‡æ–‡ä»¶
        new File([new ArrayBuffer(1024)], 'test.jpg', { type: 'image/jpeg' }),
        // PDFæ–‡ä»¶
        new File([new ArrayBuffer(2048)], 'test.pdf', { type: 'application/pdf' }),
        // å¤§æ–‡ä»¶ï¼ˆ>5MBï¼Œåº”è¯¥è¢«æ‹’ç»ï¼‰
        new File([new ArrayBuffer(6 * 1024 * 1024)], 'large.txt', { type: 'text/plain' })
      ];
      
      log('ğŸ“ æµ‹è¯•æ–‡ä»¶åˆ—è¡¨:');
      testFiles.forEach(file => {
        log(`  - ${file.name} (${file.type}, ${(file.size / 1024).toFixed(2)} KB)`);
      });
      
      log('\nå¼€å§‹æ·»åŠ æ–‡ä»¶åˆ°ä¸Šä¼ å™¨...');
      
      // é€ä¸ªæ·»åŠ æ–‡ä»¶è¿›è¡Œæµ‹è¯•
      testFiles.forEach((file, index) => {
        log(`\nğŸ“‚ æµ‹è¯•æ–‡ä»¶ ${index + 1}: ${file.name}`);
        try {
          window.testUploader.addFiles([file]);
          log(`  âœ… æ–‡ä»¶æ·»åŠ æˆåŠŸ`);
        } catch (error) {
          log(`  âŒ æ–‡ä»¶æ·»åŠ å¤±è´¥: ${error.message}`);
        }
      });
      
      // æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
      setTimeout(() => {
        const finalStats = window.testUploader.getStats();
        log(`\nğŸ“Š æœ€ç»ˆç»Ÿè®¡: é˜Ÿåˆ—${finalStats.queued}ä¸ª, æ´»åŠ¨${finalStats.active}ä¸ª, å®Œæˆ${finalStats.completed}ä¸ª, å¤±è´¥${finalStats.failed}ä¸ª`);
      }, 1000);
    };

    // æ¸…ç©ºæ—¥å¿—
    window.clearLog = function() {
      document.getElementById('log').textContent = '';
    };

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    window.addEventListener('load', function() {
      log('=== ParallelFileUploader v2.0.1 WorkeråŠŸèƒ½æµ‹è¯• ===');
      log(`æµè§ˆå™¨: ${navigator.userAgent.split('(')[0].trim()}`);
      log(`Workeræ”¯æŒ: ${typeof Worker !== 'undefined' ? 'âœ…' : 'âŒ'}`);
      log(`CPUæ ¸å¿ƒæ•°: ${navigator.hardwareConcurrency || 'æœªçŸ¥'}`);
      log('');
      log('ğŸ”§ v2.0.1 æ–°åŠŸèƒ½ç‰¹æ€§:');
      log('   âœ… è°ƒè¯•æ¨¡å¼ - è¯¦ç»†æ—¥å¿—è¾“å‡º');
      log('   âœ… é€šé…ç¬¦æ”¯æŒ - æ–‡ä»¶ç±»å‹é…ç½® "*"');
      log('   âœ… å¢å¼ºé”™è¯¯å¤„ç† - å‹å¥½çš„ä¸­æ–‡æç¤º');
      log('   âœ… é…ç½®éªŒè¯ - è‡ªåŠ¨æ£€æµ‹é—®é¢˜');
      log('   âœ… æ–°å¢API - getConfiguration(), setDebugMode()');
      log('');
      log('ğŸ’¡ ä½¿ç”¨è¯´æ˜:');
      log('   1. ç‚¹å‡»"ğŸ”§ æµ‹è¯•æ–°åŠŸèƒ½"ä½“éªŒæ–°ç‰¹æ€§');
      log('   2. ç‚¹å‡»"ğŸ”§ æµ‹è¯•æ–‡ä»¶ç±»å‹éªŒè¯"æµ‹è¯•æ–‡ä»¶é™åˆ¶');
      log('   3. é€‰æ‹©æ–‡ä»¶åç‚¹å‡»"æµ‹è¯•æ–‡ä»¶ä¸Šä¼ "æŸ¥çœ‹å¤„ç†æµç¨‹');
      log('------------------------');
    });
  </script>
</body>
</html> 